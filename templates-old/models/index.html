<div class="mx-auto">
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
    {{ range .models }}
    <div
      class="bg-background-card cursor-pointer rounded-lg shadow-md overflow-hidden transition-transform duration-300 hover:scale-105"
      hx-get="/models/{{ .ID }}"
      hx-target="#content"
      hx-push-url="true"
      hx-swap="innerHTML"
    >
      <div class="relative">
        {{ if and (not (eq .ModelVersions nil)) (gt (len .ModelVersions) 0) }}
          {{ $firstVersion := index .ModelVersions 0 }}
          {{ if gt (len $firstVersion.Images) 0 }}
            {{ $firstImage := index $firstVersion.Images 0 }}
            <div
              class="media-container"
              data-src="{{ $firstImage.URL }}"
              data-alt="{{ .Name }}"
            >
              <!-- Content will be inserted here by JavaScript -->
            </div>
            {{ end }}
        {{ end }}
        {{ if not .Checked }}
        <div class="absolute top-2 right-2 bg-green-500 text-white rounded-full p-1">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            />
          </svg>
        </div>
        {{ end }}
      </div>
      <div class="p-4">
        <h2 class="text-lg font-semibold truncate">{{ .Name }}</h2>
        <p class="text-sm text-gray-600">
          Published: {{ (index .ModelVersions 0).PublishedAt }}
        </p>
      </div>
    </div>
    {{ end }}
  </div>
</div>

<script>
  (function() {
    function loadImage(url) {
      return fetch(url)
        .then((response) => response.blob())
        .then((blob) => URL.createObjectURL(blob))
        .catch((error) => console.error("Error loading image:", error));
    }

    function setupMediaContainers() {
      const containers = document.querySelectorAll(".media-container");
      containers.forEach((container) => {
        const url = container.dataset.src;
        const alt = container.dataset.alt;

        loadImage(url).then((objectUrl) => {
          const img = new Image();
          img.onload = function () {
            container.innerHTML = `<img src="${objectUrl}" alt="${alt}" class="w-full h-48 object-cover" style="object-position: left -20px">`;
          };
          img.onerror = function () {
            const video = document.createElement("video");
            video.onloadedmetadata = function () {
              container.innerHTML = `
                <video class="w-full h-48 object-cover" controls style="object-position: left -20px">
                  <source src="${url}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
              `;
            };
            video.onerror = function () {
              container.innerHTML = `<p>Unsupported media type</p>`;
            };
            video.src = url;
          };
          img.src = objectUrl;
        });
      });
    }

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker.register('/sw.js').then(
          function (registration) {
            console.log(
              "ServiceWorker registration successful with scope: ",
              registration.scope
            );
          },
          function (err) {
            console.log("ServiceWorker registration failed: ", err);
          }
        );
      });
    }
    setupMediaContainers();
  })();

  //  htmx.on("htmx:load", setupMediaContainers);
  //  htmx.on("htmx:beforeSwap", cleanupPage);
</script>
